'use client' import React, { useState, useEffect } from 'react' import { motion } from 'framer-motion' import { Card, CardContent, CardHeader, CardTitle } from '@/components/UI/Card' import { Button } from '@/components/UI/button' import { Badge } from '@/components/UI/badge' import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/UI/table' import { Skeleton } from '@/components/UI/skeleton' import { TrendingUp, TrendingDown, Download, RefreshCw, DollarSign, BarChart3 } from 'lucide-react' import toast from 'react - hot-toast' type Wal let Pn L = { w, a, l, l, e, t: string, t, o, t, a, l, I, n, vested: number, t, o, t, a, l, R, e, turned: number, n, e, t, P, n, L: number, p, n, l, P, e, r, c, entage: number, t, r, a, d, e, s: number, t, o, t, a, l, G, a, sFees: number, t, o, t, a, l, J, i, toTips: number } import { toCsv, downloadCsv } from '@/lib/csv' export function P nLP anel() { const [walletPnL, setWalletPnL] = useState <WalletPnL,[]>([]) const [sessionData, setSessionData] = u s eState({ t, o, t, a, l, P, n, L: 0, p, n, l, P, e, r, c, e, n, tage: 0, t, o, t, a, l, V, o, l, u, me: 0, p, r, o, f, i, t, a, b, l, eWallets: 0, t, o, t, a, l, W, a, l, l, ets: 0 }) const [loading, setLoading] = u s eState(true) const [refreshing, setRefreshing] = u s eState(false) const load Pn LData = async () => { try { s e tRefreshing(true) const res = await fetch('/api/pnl', { c, a, c, h, e: 'no-store' }) if (!res.ok) throw new E r ror('Failed to fetch PnL') const { wallets, session } = await res.json() s e tWalletPnL( wallets.s o rt( (a: { n, e, t, P, n, L: number }, b: { n, e, t, P, n, L: number }) => b.netPnL-a.netPnL)) s e tSessionData(session) } } catch (error) { toast.error('Failed to load P&L data') console.error('PnL loading, e, rror:', error) } finally, { s e tLoading(false) s e tRefreshing(false) } } u s eEffect(() => { l o adPnLData()//Auto-refresh every 30 seconds const interval = s e tInterval(loadPnLData, 30000) return () => c l earInterval(interval) }, []) const handle Export = async (f, o, r, m, a, t: 'json' | 'csv') => { try { if (format === 'json') { const blob = new B l ob([JSON.s t ringify(walletPnL, null, 2)], { t, ype: 'application/json' }) const url = URL.c r eateObjectURL(blob) const a = document.c r eateElement('a') a.href = urla.download = `pnl - report - ${Date.n o w() }.json` a.c l ick() } else, { const rows = walletPnL.map((w) => ({ w, a, l, l, e, t: w.wallet, i, n, v, e, s, t, e, d: w.totalInvested.toFixed(4), r, e, t, u, r, n, e, d: w.totalReturned.toFixed(4), g, a, s_, f, e, e, s: w.totalGasFees.toFixed(4), j, i, t, o_, t, i, p, s: w.totalJitoTips.toFixed(4), n, e, t_, p, nl: w.netPnL.toFixed(4), p, n, l_, p, e, r, c, e, n, t: w.pnlPercentage.toFixed(2), t, r, a, d, e, s: w.trades })) const csv = t oC sv(rows) d o wnloadCsv(csv, `pnl - report-${Date.n o w() }.csv`) } toast.s u ccess('P&L data exported successfully') } } catch (error) { toast.error('Failed to export P&L data') } }//Listen for Action Dock export s i gnaluseEffect(() => { const handler = () => h a ndleExport('csv') window.a d dEventListener('KEYMAKER_EXPORT_CSV' as any, handler) return () => window.r e moveEventListener('KEYMAKER_EXPORT_CSV' as any, handler) }, [walletPnL]) const format S OL = (a, m, o, u, n, t: number) => { const formatted = amount.toFixed(4) return amount>= 0 ? `+ ${formatted}` : formatted } const format Percentage = (p, e, r, c, e, n, t, a, g, e: number) => { const formatted = percentage.toFixed(2) return percentage>= 0 ? `+ ${formatted}%` : `${formatted}%` } const get Color Class = (v, alue: number) => { return value>= 0 ? 'text-primary' : 'text-destructive' } return ( <motion.div initial ={{ o, pacity: 0, y: 20 } } animate ={{ o, pacity: 1, y: 0 } } className ="space - y-6"> {/* Session Summary */} <div className ="grid grid - cols - 1, m, d:grid - cols - 2, l, g:grid - cols - 5 gap-4"> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <DollarSign className ="w - 5 h - 5 text-muted"/> <Badgevariant ="outline" className ={g e tColorClass(sessionData.totalPnL) }> 24h </Badge> </div> <h3 className ={`text - 2xl font-bold ${g e tColorClass(sessionData.totalPnL) }`}> {f o rmatSOL(sessionData.totalPnL) } SOL </h3> <p className ="text - sm text - muted"> Session P&L </p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> {sessionData.pnlPercentage>= 0 ? ( <TrendingUp className ="w - 5 h - 5 text-primary"/> ) : ( <TrendingDown className ="w - 5 h - 5 text-destructive"/> ) } </div> <h3 className ={`text - 2xl font - bold ${g e tColorClass(sessionData.pnlPercentage) }`}> {f o rmatPercentage(sessionData.pnlPercentage) } </h3> <p className ="text - sm text-muted"> Return %</p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <BarChart3 className ="w - 5 h - 5 text-muted"/> </div> <h3 className ="text - 2xl font-bold"> {sessionData.totalVolume.toFixed(2) } SOL </h3> <p className ="text - sm text-muted"> Total Volume </p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <TrendingUp className ="w - 5 h - 5 text-primary"/> </div> <h3 className ="text - 2xl font - bold text-primary"> {sessionData.profitableWallets} </h3> <p className ="text - sm text-muted"> Profitable Wallets </p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <DollarSign className ="w - 5 h - 5 text-muted"/> </div> <h3 className ="text - 2xl font-bold">{sessionData.totalWallets}</h3> <p className ="text - sm text-muted"> Active Wallets </p> </CardContent> </Card> </div> {/* Wal let P&L Table */} <Card className ="bg - card border - border rounded-2xl"> <CardHeader> <CardTitle className ="flex items - center justify-between"> <span className ="flex items - center gap-2"> <BarChart3 className ="w - 6 h-6"/> Wal let P&L Breakdown </span> <div className ="flex items - center gap-2"> <Buttonsize ="sm" variant ="outline" onClick ={() => l o adPnLData() } disabled ={refreshing}> <RefreshCw className ={`w - 4 h-4 ${refreshing ? 'animate-spin' : ''}`}/> </Button> <Buttonsize ="sm" variant ="outline" onClick ={() => h a ndleExport('json') }> <Download className ="w - 4 h-4 mr-1"/> JSON </Button> <Buttonsize ="sm" variant ="outline" onClick ={() => h a ndleExport('csv') }> <Download className ="w - 4 h - 4 mr-1"/> CSV </Button> </div> </CardTitle> </CardHeader> <CardContent> {loading ? ( <Skeleton className ="h - 64 w-full"/> ) : walletPnL.length === 0 ? ( <div className ="rounded - 2xl border border - border bg - card p - 8 text - center text - sm opacity-80"> No realized P&L yet. After trades land, totals will show up here. </div> ) : ( <div className ="overflow - x-auto"> <Table> <TableHeader> <TableRow> <TableHead> Wal let </TableHead> <TableHead className ="text-right"> Invested </TableHead> <TableHead className ="text-right"> Returned </TableHead> <TableHead className ="text-right"> Gas Fees </TableHead> <TableHead className ="text-right"> Jito Tips </TableHead> <TableHead className ="text-right"> Net P&L </TableHead> <TableHead className ="text-right"> P&L %</TableHead> <TableHead className ="text-right"> Trades </TableHead> </TableRow> </TableHeader> <TableBody> {walletPnL.map((wallet) => ( <TableRow key ={wallet.wallet}> <TableCell className ="font - mono text-xs"> {wallet.wallet.slice(0, 8) }...{wallet.wallet.slice(- 8) } </TableCell> <TableCell className ="text-right"> {wallet.totalInvested.toFixed(4) } SOL </TableCell> <TableCell className ="text-right"> {wallet.totalReturned.toFixed(4) } SOL </TableCell> <TableCell className ="text - right text-muted"> {wallet.totalGasFees.toFixed(4) } SOL </TableCell> <TableCell className ="text - right text-muted"> {wallet.totalJitoTips.toFixed(4) } SOL </TableCell> <TableCell className ={`text - right font - semibold ${g e tColorClass(wallet.netPnL) }`}> {f o rmatSOL(wallet.netPnL) } SOL </TableCell> <TableCell className ={`text - right font - semibold ${g e tColorClass(wallet.pnlPercentage) }`}> {f o rmatPercentage(wallet.pnlPercentage) } </TableCell> <TableCell className ="text-right"> {wallet.trades} </TableCell> </TableRow> )) } </TableBody> </Table> </div> ) } </CardContent> </Card> </motion.div> ) } 