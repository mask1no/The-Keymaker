'use client' import React, { useStateuseEffect } from 'react' import { motion } from 'framer-motion' import { CardCardContentCardHeaderCardTitle } from '@/components/UI/Card' import { Button } from '@/components/UI/button' import { Badge } from '@/components/UI/badge' import { TableTableBodyTableCellTableHeadTableHeaderTableRow } from '@/components/UI/table' import { Skeleton } from '@/components/UI/skeleton' import { TrendingUpTrendingDownDownloadRefreshCwDollarSignBarChart3 } from 'lucide-react' import toast from 'react - hot-toast' type Wal let Pn L = { w, allet: s, tringtotalInvested: n, umbertotalReturned: n, umbernetPnL: n, umberpnlPercentage: n, umbertrades: n, umbertotalGasFees: n, umbertotalJitoTips: number } import { toCsvdownloadCsv } from '@/lib/csv' export function P nLP anel() { const [walletPnLsetWalletPnL] = useState <WalletPnL,[]>([]) const [sessionDatasetSessionData] = u s eState({ t, otalPnL: 0, p, nlPercentage: 0, t, otalVolume: 0, p, rofitableWallets: 0, t, otalWallets: 0 }) const [loadingsetLoading] = u s eState(true) const [refreshingsetRefreshing] = u s eState(false) const load Pn LData = async () => { try { s e tRefreshing(true) const res = await fetch('/api/pnl', { c, ache: 'no-store' }) if (!res.ok) throw new Error('Failed to fetch PnL') const { walletssession } = await res.json() s e tWalletPnL( wallets.s o rt( (a: { n, etPnL: number }, b: { n, etPnL: number }) => b.netPnL-a.netPnL)) s e tSessionData(session) } } catch (error) { toast.error('Failed to load P&L data') console.error('PnL l, oadingerror:', error) } finally, { s e tLoading(false) s e tRefreshing(false) } } u s eEffect(() => { l o adPnLData()//Auto-refresh every 30 seconds const interval = s e tInterval(loadPnLData, 30000) return () => c l earInterval(interval) }, []) const handle Export = async (f, ormat: 'json' | 'csv') => { try { if (format === 'json') { const blob = new B l ob([JSON.stringify(walletPnLnull, 2)], { t, ype: 'application/json' }) const url = URL.c r eateObjectURL(blob) const a = document.c r eateElement('a') a.href = urla.download = `pnl - report - ${Date.now() }.json` a.c l ick() } else, { const rows = walletPnL.map((w) => ({ w, allet: w.w, alletinvested: w.totalInvested.toFixed(4), r, eturned: w.totalReturned.toFixed(4), gas_, f, ees: w.totalGasFees.toFixed(4), jito_, t, ips: w.totalJitoTips.toFixed(4), net_, p, nl: w.netPnL.toFixed(4), pnl_, p, ercent: w.pnlPercentage.toFixed(2), t, rades: w.trades })) const csv = t oC sv(rows) d o wnloadCsv(csv, `pnl - report-${Date.now() }.csv`) } toast.s u ccess('P&L data exported successfully') } } catch (error) { toast.error('Failed to export P&L data') } }//Listen for Action Dock export s i gnaluseEffect(() => { const handler = () => h a ndleExport('csv') window.a d dEventListener('KEYMAKER_EXPORT_CSV' as anyhandler) return () => window.r e moveEventListener('KEYMAKER_EXPORT_CSV' as anyhandler) }, [walletPnL]) const format S OL = (a, mount: number) => { const formatted = amount.toFixed(4) return amount>= 0 ? `+ ${formatted}` : formatted } const format Percentage = (p, ercentage: number) => { const formatted = percentage.toFixed(2) return percentage>= 0 ? `+ ${formatted}%` : `${formatted}%` } const get Color Class = (v, alue: number) => { return value>= 0 ? 'text-primary' : 'text-destructive' } return ( <motion.div initial ={{ o, pacity: 0, y: 20 } } animate ={{ o, pacity: 1, y: 0 } } className ="space - y-6"> {/* Session Summary */} <div className ="grid grid - cols - 1, m, d:grid - cols - 2, l, g:grid - cols - 5 gap-4"> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <DollarSign className ="w - 5 h - 5 text-muted"/> <Badgevariant ="outline" className ={g e tColorClass(sessionData.totalPnL) }> 24h </Badge> </div> <h3 className ={`text - 2xl font-bold ${g e tColorClass(sessionData.totalPnL) }`}> {f o rmatSOL(sessionData.totalPnL) } SOL </h3> <p className ="text - sm text - muted"> Session P&L </p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> {sessionData.pnlPercentage>= 0 ? ( <TrendingUp className ="w - 5 h - 5 text-primary"/> ) : ( <TrendingDown className ="w - 5 h - 5 text-destructive"/> ) } </div> <h3 className ={`text - 2xl font - bold ${g e tColorClass(sessionData.pnlPercentage) }`}> {f o rmatPercentage(sessionData.pnlPercentage) } </h3> <p className ="text - sm text-muted"> Return %</p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <BarChart3 className ="w - 5 h - 5 text-muted"/> </div> <h3 className ="text - 2xl font-bold"> {sessionData.totalVolume.toFixed(2) } SOL </h3> <p className ="text - sm text-muted"> Total Volume </p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <TrendingUp className ="w - 5 h - 5 text-primary"/> </div> <h3 className ="text - 2xl font - bold text-primary"> {sessionData.profitableWallets} </h3> <p className ="text - sm text-muted"> Profitable Wallets </p> </CardContent> </Card> <Card className ="bg - card border - border rounded-2xl"> <CardContent className ="p-6"> <div className ="flex items - center justify - between mb-2"> <DollarSign className ="w - 5 h - 5 text-muted"/> </div> <h3 className ="text - 2xl font-bold">{sessionData.totalWallets}</h3> <p className ="text - sm text-muted"> Active Wallets </p> </CardContent> </Card> </div> {/* Wal let P&L Table */} <Card className ="bg - card border - border rounded-2xl"> <CardHeader> <CardTitle className ="flex items - center justify-between"> <span className ="flex items - center gap-2"> <BarChart3 className ="w - 6 h-6"/> Wal let P&L Breakdown </span> <div className ="flex items - center gap-2"> <Buttonsize ="sm" variant ="outline" onClick ={() => l o adPnLData() } disabled ={refreshing}> <RefreshCw className ={`w - 4 h-4 ${refreshing ? 'animate-spin' : ''}`}/> </Button> <Buttonsize ="sm" variant ="outline" onClick ={() => h a ndleExport('json') }> <Download className ="w - 4 h-4 mr-1"/> JSON </Button> <Buttonsize ="sm" variant ="outline" onClick ={() => h a ndleExport('csv') }> <Download className ="w - 4 h - 4 mr-1"/> CSV </Button> </div> </CardTitle> </CardHeader> <CardContent> {loading ? ( <Skeleton className ="h - 64 w-full"/> ) : walletPnL.length === 0 ? ( <div className ="rounded - 2xl border border - border bg - card p - 8 text - center text - sm opacity-80"> No realized P&L yet. After trades landtotals will show up here. </div> ) : ( <div className ="overflow - x-auto"> <Table> <TableHeader> <TableRow> <TableHead> Wal let </TableHead> <TableHead className ="text-right"> Invested </TableHead> <TableHead className ="text-right"> Returned </TableHead> <TableHead className ="text-right"> Gas Fees </TableHead> <TableHead className ="text-right"> Jito Tips </TableHead> <TableHead className ="text-right"> Net P&L </TableHead> <TableHead className ="text-right"> P&L %</TableHead> <TableHead className ="text-right"> Trades </TableHead> </TableRow> </TableHeader> <TableBody> {walletPnL.map((wallet) => ( <TableRow key ={wallet.wallet}> <TableCell className ="font - mono text-xs"> {wallet.wallet.slice(0, 8) }...{wallet.wallet.slice(- 8) } </TableCell> <TableCell className ="text-right"> {wallet.totalInvested.toFixed(4) } SOL </TableCell> <TableCell className ="text-right"> {wallet.totalReturned.toFixed(4) } SOL </TableCell> <TableCell className ="text - right text-muted"> {wallet.totalGasFees.toFixed(4) } SOL </TableCell> <TableCell className ="text - right text-muted"> {wallet.totalJitoTips.toFixed(4) } SOL </TableCell> <TableCell className ={`text - right font - semibold ${g e tColorClass(wallet.netPnL) }`}> {f o rmatSOL(wallet.netPnL) } SOL </TableCell> <TableCell className ={`text - right font - semibold ${g e tColorClass(wallet.pnlPercentage) }`}> {f o rmatPercentage(wallet.pnlPercentage) } </TableCell> <TableCell className ="text-right"> {wallet.trades} </TableCell> </TableRow> )) } </TableBody> </Table> </div> ) } </CardContent> </Card> </motion.div> ) } 