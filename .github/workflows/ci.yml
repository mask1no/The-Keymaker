name: Continuous Integration

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Node version check
        run: pnpm check:node
        
      - name: TypeScript type check
        run: pnpm type-check
        
      - name: Core TypeScript build
        run: pnpm core:build
        
      - name: Lint
        run: pnpm lint
        
      - name: Run tests with coverage
        run: pnpm test:coverage
        
      - name: Check test coverage threshold
        run: |
          COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.statements.pct')
          echo "Current coverage: $COVERAGE%"
          if (( $(echo "$COVERAGE < 45" | bc -l) )); then
            echo "âŒ Coverage below minimum 45%"
            exit 1
          fi
          echo "âœ… Coverage meets minimum threshold"
          
  build:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build application
        run: pnpm build
        
      - name: Analyze bundle size
        run: pnpm analyze
        
      - name: Check bundle size limits
        run: |
          # Check if any route exceeds 100KB
          if [ -f .next/build-manifest.json ]; then
            echo "âœ… Build completed successfully"
            echo "ðŸ“Š Bundle analysis complete"
            # Add bundle size validation here if needed
          fi
          
  security:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Audit dependencies
        run: pnpm audit --audit-level high
        continue-on-error: true
        
      - name: Scan for secrets
        run: pnpm secrets:scan
        continue-on-error: true
        
  acceptance:
    runs-on: ubuntu-latest
    needs: [test, build]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'
          
      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run acceptance tests
        run: node scripts/acceptance-v1.5.2.js
        
      - name: Verify application integrity
        run: pnpm verify
        continue-on-error: true