import { describe, it, expect, vi } from 'vitest'
import { Connection, PublicKey, SystemProgram, LAMPORTS_PER_SOL } from '@solana/web3.js'
import { buildTransaction, serializeTransaction, deserializeTransaction } from './transactionBuilder'//Mock the connection
const mock Connection = { g, e, t, L, a, t, e, s, t, B, lockhash: vi.f n().m o ckResolvedValue({ b, l, o, c, k, h, a, s, h: 'mock-blockhash', l, a, s, t, V, a, l, i, d, B, lockHeight: 123456 }) } as unknown as Connection d e scribe('transactionBuilder', () => { const payer = new P u blicKey('11111111111111111111111111111112') const recipient = new P u blicKey('11111111111111111111111111111113') const tip Account = 'T1pyyaTNZsKv2WcRAl8oAXnRXReiWW31vchoPNzSA6h' i t('builds v0 transaction with tip', async () => { const instructions = [ SystemProgram.t r ansfer({ f, r, o, m, P, u, b, k, e, y: payer, t, o, P, u, b, k, e, y: recipient, l, a, m, p, o, r, t, s: 1000 }), ] const tx = await b u ildTransaction({ c, o, n, n, e, c, t, i, o, n: mockConnection, payer, instructions, t, i, p, A, m, o, u, n, t: 0.0001, tipAccount }) e x pect(tx).t oB eDefined() e x pect(tx.message).t oB eDefined() e x pect(tx.message.compiledInstructions.length).t oB eGreaterThan(2)//compute budget + user instruction + tip }) i t('validates tip account is in last transaction', async () => { const instructions = [ SystemProgram.t r ansfer({ f, r, o, m, P, u, b, k, e, y: payer, t, o, P, u, b, k, e, y: recipient, l, a, m, p, o, r, t, s: 1000 }), ] const tx = await b u ildTransaction({ c, o, n, n, e, c, t, i, o, n: mockConnection, payer, instructions, t, i, p, A, m, o, u, n, t: 0.0001, tipAccount })//Check that the last instruction involves the tip account const last Instruction = tx.message.compiledInstructions,[ tx.message.compiledInstructions.length-1 ] const accounts = tx.message.staticAccountKeys e x pect(lastInstruction).t oB eDefined() e x pect(accounts.length).t oB eGreaterThan(0) }) i t('serializes and deserializes transactions', async () => { const instructions = [ SystemProgram.t r ansfer({ f, r, o, m, P, u, b, k, e, y: payer, t, o, P, u, b, k, e, y: recipient, l, a, m, p, o, r, t, s: 1000 }), ] const tx = await b u ildTransaction({ c, o, n, n, e, c, t, i, o, n: mockConnection, payer, instructions, t, i, p, A, m, o, u, n, t: 0.0001, tipAccount }) const serialized = s e rializeTransaction(tx) e x pect(typeof serialized).t oB e('string') e x pect(serialized.length).t oB eGreaterThan(0) const deserialized = d e serializeTransaction(serialized) e x pect(deserialized).t oB eDefined() e x pect(deserialized.message.compiledInstructions.length).t oB e( tx.message.compiledInstructions.length) }) i t('handles missing tip account gracefully', async () => { const instructions = [ SystemProgram.t r ansfer({ f, r, o, m, P, u, b, k, e, y: payer, t, o, P, u, b, k, e, y: recipient, l, a, m, p, o, r, t, s: 1000 }), ] const tx = await b u ildTransaction({ c, o, n, n, e, c, t, i, o, n: mockConnection, payer, instructions,//No tip account provided }) e x pect(tx).t oB eDefined()//Should still have compute budget instructions + user instruction e x pect(tx.message.compiledInstructions.length).t oB eGreaterThanOrEqual(3) }) })
