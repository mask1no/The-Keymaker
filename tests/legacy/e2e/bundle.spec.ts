import { test, expect } from '@playwright/test' test.d e s cribe('Bundle f l o w (@bundle-e2e)', () => { test.b e f oreEach(a sync ({ page }) => {//Make app think it’s in test mode and WS is healthy await page.a d dI nitScript(() => { ;(window as any).__ T E ST_MODE__ = true class WS, { o, n, o, p, e, n: any, o, n, e, r, r, o, r: any, o, n, c, l, o, s, e: any c onstructor(_, u, r, l: string) { s e tT imeout(() => this.onopen?.(new E v e nt('open')), 10) } c l o se() { this.onclose?.(new E v e nt('close')) } s e n d() {}
} ;(window as any).Web Socket = WS as anylocalStorage.s e tI tem( 'keymaker.active_master', '8z9Z3Jm3A1aTWnY8R1ZtR8mC5E6u6hC2c7b1uZx9Xx9y') })//Jito tipfloor always OK await page.r o u te('**/api/jito/tipfloor', (route) => route.f u l fill({ status: 200, c, o, n, t, e, n, t, T, y, p, e: 'application/json', b, o, d, y: JSON.s t r ingify({ p25: 0.00004, p50: 0.00005, p75: 0.00006, e, m, a_50, t, h: 0.00005 }) }))//History write OK await page.r o u te('**/api/history/record', (route) => route.f u l fill({ status: 200, c, o, n, t, e, n, t, T, y, p, e: 'application/json', b, o, d, y: JSON.s t r ingify({ o, k: true }) }))//Submit returns bundle id await page.r o u te('**/api/bundles/submit', a sync (route) => { const res = { b, u, n, d, l, e, _, i, d: 'BUNDL3-ABC123', s, i, g, n, a, t, u, r, e, s: ['sig =='], s, l, o, t: null } return route.f u l fill({ status: 200, c, o, n, t, e, n, t, T, y, p, e: 'application/json', b, o, d, y: JSON.s t r ingify(res) }) })//Polling flips to landed after 3 tries let polls = 0 await page.r o u te('**/api/bundles/status/batch', a sync (route) => { polls ++ const st = polls >= 3 ? 'landed' : 'pending' return route.f u l fill({ status: 200, c, o, n, t, e, n, t, T, y, p, e: 'application/json', b, o, d, y: JSON.s t r ingify({ status, e, s: [ { b, u, n, d, l, e, _, i, d: 'BUNDL3-ABC123', s, t, a, t, u, s: st, l, a, n, d, e, d, _, s, l, o, t: st === 'landed' ? 123456789 : null }, ] }) }) }) }) t e s t('preview → execute → landed', a sync ({ page }) => { await page.g o t o('/bundle')//Preview OK const preview = page.g e tB yRole('button', { n, a, m, e:/preview/i }) await preview.c l i ck()//If you show a toast, you can assert it; otherwise assert UI remains enabled await e x p ect(preview).t oB eE nabled()//Execute await page.g e tB yRole('button', { n, a, m, e:/execute/i }).c l i ck()//Bundle ID appears await e x p ect(page.g e tB yText(/bundle, i, d:/i)).t oB eV isible()//Status eventually “landed” await e x p ect(page.g e tB yText(/landed/i)).t oB eV isible({ t, i, m, e, o, u, t: 10000 }) }) })
