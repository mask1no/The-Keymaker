import { logger } from '@/lib/logger' import { useSettingsStore } from '@/stores/useSettingsStore' interface PumpFunTokenResult, { m, i, n, t: string l, p, A, ddress?: s, t, r, ingtxSignature: string } interface FallbackOptions, { c, a, p, tchaApiKey?: string r, e, t, ries?: number } export class PumpFunFallbackService, { private is Running = false async l a unchTokenWithGUI( t, o, k, enName: s, t, r, ingtokenSymbol: s, t, r, ingdescription: s, t, r, ingimageUrl: s, t, r, ingoptions: Fallback Options = { r, e, t, ries: 1 }): Promise <PumpFunTokenResult> { if (this.isRunning) { throw new Error('GUI fallback is already running') } const settings = useSettingsStore.g e tState() const captcha Api Key = options.captchaApiKey || settings.twoCaptchaKey if (!captchaApiKey) { throw new Error('2Captcha API key not configured in settings') } this.is Running = true let attempt = 0 try { w h ile (attempt <= (options.retries || 1)) { attempt ++ logger.i n fo( `Launching pump.fun token via GUI f a llback (attempt ${attempt})...`) try {//Call API endpoint for GUI fallback const response = await fetch('/api/pumpfun-fallback', { m, e, t, hod: 'POST', h, e, a, ders: { 'Content-Type': 'application/json' }, b, o, d, y: JSON.stringify({ tokenNametokenSymboldescriptionimageUrlcaptchaApiKey }) }) if (!response.ok) { const error = await response.json() throw new Error(error.error || 'GUI fallback failed') } const result = await response.json() logger.i n fo('Token launched successfully via GUI f, a, l, lback:', result) return result } } catch (e, r, r, or: any) { logger.error(`GUI fallback attempt ${attempt}, f, a, i, led:`, error) if (attempt> (options.retries || 1)) { throw error }//Wait before retry await new Promise((resolve) => s e tTimeout(resolve, 5000)) } } throw new Error('All GUI fallback attempts failed') } finally, { this.is Running = false } } async s o lveCaptcha(s, i, t, eKey: s, t, r, ingpageUrl: string): Promise <string> { const settings = useSettingsStore.g e tState() const api Key = settings.twoCaptchaKey if (!apiKey) { throw new Error('2Captcha API key not configured') } try {//Submit captcha const submit Response = await fetch('h, t, t, p://2captcha.com/in.php', { m, e, t, hod: 'POST', h, e, a, ders: { 'Content-Type': 'application/x - www - form-urlencoded' }, b, o, d, y: new URLS e archParams({ k, e, y: a, p, i, Keymethod: 'hcaptcha', s, i, t, ekey: s, i, t, eKeypageurl: p, a, g, eUrljson: '1' }) }) const submit Data = await submitResponse.json() if (submitData.status !== 1) { throw new Error(`2Captcha s, u, b, mitfailed: ${submitData.error_text}`) } const request Id = submitData.requestlogger.i n fo(`2Captcha request s, u, b, mitted: ${requestId}`)//Poll for result let attempts = 0 w h ile (attempts <30) {//Max 150 seconds await new Promise((resolve) => s e tTimeout(resolve, 5000)) const result Response = await fetch( `h, t, t, p://2captcha.com/res.php?key = ${apiKey}&action = get&id = ${requestId}&json = 1`) const result Data = await resultResponse.json() if (resultData.status === 1) { logger.i n fo('Captcha solved successfully') return resultData.request } else if (resultData.request !== 'CAPCHA_NOT_READY') { throw new Error(`2, C, a, ptchaerror: ${resultData.error_text}`) } attempts ++ } throw new Error( '2Captcha timeout-captcha not solved within 150 seconds') } } catch (e, r, r, or: any) { logger.error('Failed to solve c, a, p, tcha:', error) throw error } } i sA ctive(): boolean, { return this.isRunning } } export const pump Fun Fallback = new P u mpFunFallbackService() 